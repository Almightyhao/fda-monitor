name: FDA Monitor Automation

# è§¸ç™¼æ™‚æ©Ÿ
on:
  schedule:
    # å°ç£æ™‚é–“ 00:00 = UTC 16:00
    - cron: '0 16 * * *'
  # å…è¨±æ‰‹å‹•æŒ‰æŒ‰éˆ•åŸ·è¡Œ
  workflow_dispatch:

# æ¬Šé™è¨­å®š (å…è¨±ä¿®æ”¹æª”æ¡ˆèˆ‡ç™¼å¸ƒç¶²é )
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ä¸‹è¼‰ç¨‹å¼ç¢¼ (å¿…é ˆä¿ç•™)
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. è¨­å®š Python ç’°å¢ƒ (å·²æ¢å¾©)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. å®‰è£ Python å¥—ä»¶ (å·²æ¢å¾©)
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      # 4. åŸ·è¡Œçˆ¬èŸ² (æŠ“è³‡æ–™ + æ›´æ–° data.json) (å·²æ¢å¾©)
      - name: Run Crawler
        run: python scripts/update_data.py

      # 5. å¦‚æœ data.json æœ‰è®Šå‹•ï¼Œå°±æäº¤(Commit)å›ä¸»åˆ†æ”¯ (å·²æ¢å¾©)
      # ğŸ‘‡ æ³¨æ„ï¼šä¸‹é¢é€™ä¸€è¡Œæˆ‘å¹«æ‚¨è£œä¸Šäº† # è™Ÿ
      # 5. å¦‚æœ data.json æœ‰è®Šå‹•ï¼Œå°±æäº¤(Commit)å›ä¸»åˆ†æ”¯
      - name: Commit data changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add public/data.json
          # å¦‚æœæ²’è®Šå‹•å°±ä¸åšå‹•ä½œï¼Œæœ‰è®Šå‹•æ‰ commit
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update: FDA data" && git push)

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ --- ä»¥ä¸‹ç¶²é æ‰“åŒ…å€å¡Šå¿…é ˆä¿ç•™ï¼ --- ğŸ‘‡ğŸ‘‡ğŸ‘‡

      # 6. è¨­å®š Node.js (æº–å‚™æ‰“åŒ…ç¶²é )
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20  # ğŸ‘ˆ é‡è¦ï¼å·²å¹«æ‚¨æ”¹æˆ 20ï¼Œä¸ç„¶ç­‰ä¸€ä¸‹ç¶²é æ‰“åŒ…æœƒå¤±æ•—

      # 7. å®‰è£ç¶²é å¥—ä»¶ (åŠ å…¥ --legacy-peer-deps é¿é–‹ React 19 ç›¸å®¹å•é¡Œ)
      - name: Install Node dependencies
        run: npm install --legacy-peer-deps

      # 8. æ‰“åŒ…ç¶²é  (Build)
      - name: Build React App
        run: npm run build
        env:
           # ç¢ºä¿ç¶²é çŸ¥é“å®ƒåœ¨ GitHub ä¸Š (é€™è¡Œå¾ˆé‡è¦)
           VITE_BASE_URL: /fda-monitor/ 

      # 9. ç™¼å¸ƒåˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist # Vite æ‰“åŒ…å¾Œçš„è³‡æ–™å¤¾
          branch: gh-pages # ç™¼å¸ƒåˆ°é€™å€‹åˆ†æ”¯
